<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horiba U-52 Field App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.3.1"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0066cc;
      --primary-light: #4da6ff;
      --primary-dark: #004d99;
      --secondary: #e6f2ff;
      --danger: #dc3545;
      --danger-light: #ff6b7b;
      --success: #28a745;
      --success-light: #5cb85c;
      --warning: #ffc107;
      --warning-light: #ffd966;
      --info: #17a2b8;
      --dark: #343a40;
      --light: #f8f9fa;
      --gray: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }
    
    .header {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      position: relative;
    }
    
    .header h1 {
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      opacity: 0.9;
      font-weight: 300;
    }
    
    .header-actions {
      position: absolute;
      right: 20px;
      top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
    }
    
    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background-color: var(--danger-light);
    }
    
    .btn-success {
      background-color: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background-color: var(--success-light);
    }
    
    .btn-warning {
      background-color: var(--warning);
      color: black;
    }
    
    .btn-warning:hover {
      background-color: var(--warning-light);
    }
    
    .tabs {
      display: flex;
      background-color: #f1f3f5;
      padding: 0 20px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 14px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--gray);
      position: relative;
      transition: var(--transition);
      display: flex;
      align-items: center;
    }
    
    .tab-btn i {
      margin-right: 8px;
    }
    
    .tab-btn.active {
      color: var(--primary);
      background-color: white;
    }
    
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary);
    }
    
    .tab-btn .badge {
      margin-left: 8px;
      background-color: var(--primary-light);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
      outline: none;
    }
    
    .input-group {
      display: flex;
      align-items: center;
    }
    
    .input-group .form-control {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    .input-group-append {
      display: flex;
    }
    
    .input-group-text {
      padding: 12px;
      background-color: #f1f3f5;
      border: 1px solid #ddd;
      border-left: none;
      border-top-right-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .timer-display {
      font-size: 1.5rem;
      text-align: center;
      margin: 20px 0;
      font-weight: 600;
      color: var(--primary);
    }
    
    .progress-container {
      height: 12px;
      background-color: #eee;
      border-radius: 6px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .card-title {
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    
    .card-title i {
      margin-right: 10px;
    }
    
    .instruction-card {
      background: var(--secondary);
      border-left: 4px solid var(--primary);
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .warning-card {
      background: #fff8e6;
      border-left: 4px solid var(--warning);
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .success-card {
      background: #e8f5e9;
      border-left: 4px solid var(--success);
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .danger-card {
      background: #ffebee;
      border-left: 4px solid var(--danger);
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      font-weight: bold;
      border-radius: 50%;
      margin-right: 12px;
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 30px;
    }
    
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      margin: 20px 0;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .measurement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .measurement-item {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 15px;
      transition: var(--transition);
    }
    
    .measurement-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .measurement-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 10px 0;
      color: var(--primary);
    }
    
    .measurement-meta {
      display: flex;
      justify-content: space-between;
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .measurement-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: white;
    }
    
    .badge-success {
      background-color: var(--success-light);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning-light);
      color: black;
    }
    
    .badge-danger {
      background-color: var(--danger-light);
      color: white;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .status-good {
      background-color: var(--success);
    }
    
    .status-warning {
      background-color: var(--warning);
    }
    
    .status-bad {
      background-color: var(--danger);
    }
    
    .sensor-status {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .sensor-status-item {
      flex: 1;
      min-width: 200px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 15px;
      display: flex;
      align-items: center;
    }
    
    .sensor-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: var(--primary);
    }
    
    .sensor-info {
      flex: 1;
    }
    
    .sensor-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .sensor-details {
      font-size: 0.85rem;
      color: var(--gray);
    }
    
    .floating-action-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 100;
      transition: var(--transition);
    }
    
    .floating-action-btn:hover {
      transform: scale(1.1);
      background-color: var(--primary-dark);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: var(--transition);
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-weight: 600;
      font-size: 1.2rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .tour-highlight {
      position: fixed;
      z-index: 999;
      background-color: rgba(0, 102, 204, 0.3);
      border-radius: var(--border-radius);
      pointer-events: none;
      transition: all 0.3s ease;
    }
    
    .tour-tooltip {
      position: fixed;
      z-index: 1000;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      max-width: 300px;
      padding: 20px;
      transform: translateY(10px);
      opacity: 0;
      transition: var(--transition);
    }
    
    .tour-tooltip.active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .tour-tooltip-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .tour-tooltip-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .tour-progress {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
        padding: 0;
      }
      
      .tab-btn {
        justify-content: space-between;
        border-bottom: 1px solid #ddd;
      }
      
      .tab-btn.active {
        border-bottom: 1px solid #ddd;
      }
      
      .tab-btn.active::after {
        display: none;
      }
      
      .measurement-grid {
        grid-template-columns: 1fr;
      }
      
      .header-actions {
        position: static;
        margin-top: 15px;
        justify-content: flex-end;
      }
    }
    
    /* Animation classes */
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 102, 204, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-tint"></i> Horiba U-52 Water Quality Meter</h1>
        <p>Complete field application for calibration, measurement, and data logging</p>
        
        <div class="header-actions">
          <button class="btn btn-outline" onclick="showSettingsModal()">
            <i class="fas fa-cog"></i> Settings
          </button>
          <button class="btn btn-outline" onclick="startTour()">
            <i class="fas fa-question-circle"></i> Help
          </button>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab-btn active" onclick="openTab('dashboard')">
          <i class="fas fa-home"></i> Dashboard
        </button>
        <button class="tab-btn" onclick="openTab('calibration')">
          <i class="fas fa-sliders-h"></i> Calibration
        </button>
        <button class="tab-btn" onclick="openTab('measurement')">
          <i class="fas fa-flask"></i> Measurement
          <span class="badge" id="measurement-badge">0</span>
        </button>
        <button class="tab-btn" onclick="openTab('data')">
          <i class="fas fa-database"></i> Data Log
        </button>
        <button class="tab-btn" onclick="openTab('videos')">
          <i class="fas fa-video"></i> Guides
        </button>
      </div>
      
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> Recent Measurements</h2>
            <button class="btn btn-primary" onclick="openTab('measurement')">
              <i class="fas fa-plus"></i> New Measurement
            </button>
          </div>
          
          <div class="chart-container">
            <canvas id="dashboard-chart"></canvas>
          </div>
        </div>
        
        <div class="sensor-status">
          <div class="sensor-status-item">
            <div class="sensor-icon">
              <i class="fas fa-water"></i>
            </div>
            <div class="sensor-info">
              <div class="sensor-name">pH Sensor</div>
              <div class="sensor-details">
                <span class="status-indicator status-good"></span>
                <span id="ph-status">Calibrated 2 hours ago</span>
              </div>
            </div>
          </div>
          
          <div class="sensor-status-item">
            <div class="sensor-icon">
              <i class="fas fa-wind"></i>
            </div>
            <div class="sensor-info">
              <div class="sensor-name">DO Sensor</div>
              <div class="sensor-details">
                <span class="status-indicator status-warning"></span>
                <span id="do-status">Calibrated 1 day ago</span>
              </div>
            </div>
          </div>
          
          <div class="sensor-status-item">
            <div class="sensor-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="sensor-info">
              <div class="sensor-name">Conductivity</div>
              <div class="sensor-details">
                <span class="status-indicator status-good"></span>
                <span id="cond-status">Calibrated 5 hours ago</span>
              </div>
            </div>
          </div>
          
          <div class="sensor-status-item">
            <div class="sensor-icon">
              <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="sensor-info">
              <div class="sensor-name">Temperature</div>
              <div class="sensor-details">
                <span class="status-indicator status-good"></span>
                <span id="temp-status">Calibrated 1 week ago</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-clipboard-list"></i> Quick Actions</h2>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            <button class="btn btn-primary" onclick="openTab('calibration')">
              <i class="fas fa-sliders-h"></i> Calibrate Sensors
            </button>
            <button class="btn btn-success" onclick="quickMeasurement('pH')">
              <i class="fas fa-water"></i> pH Measurement
            </button>
            <button class="btn btn-success" onclick="quickMeasurement('DO')">
              <i class="fas fa-wind"></i> DO Measurement
            </button>
            <button class="btn btn-success" onclick="quickMeasurement('all')">
              <i class="fas fa-vial"></i> Full Panel
            </button>
          </div>
        </div>
      </div>
      
      <!-- Calibration Tab -->
      <div id="calibration" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-sliders-h"></i> Probe Calibration</h2>
            <button class="btn btn-outline" onclick="showCalibrationHelp()">
              <i class="fas fa-question-circle"></i> Help
            </button>
          </div>
          
          <div class="form-group">
            <label for="calibration-parameter">Select Parameter</label>
            <select id="calibration-parameter" class="form-control" onchange="updateCalibrationSteps()">
              <option value="">-- Select Parameter --</option>
              <option value="pH">pH</option>
              <option value="DO">Dissolved Oxygen</option>
              <option value="conductivity">Conductivity</option>
              <option value="temperature">Temperature</option>
            </select>
          </div>
          
          <div id="calibration-steps">
            <div class="instruction-card">
              <h3><i class="fas fa-info-circle"></i> Calibration Guide</h3>
              <p>Select a parameter above to begin the calibration process. Ensure you have the proper calibration solutions ready before starting.</p>
              <p>For best results, calibrate:</p>
              <ul>
                <li>Before first use each day</li>
                <li>After changing probes</li>
                <li>When measurements seem inaccurate</li>
                <li>After extreme temperature changes</li>
              </ul>
            </div>
          </div>
          
          <div class="video-container" id="calibration-video" style="display:none;"></div>
          
          <div class="timer-display" id="timer-display" style="display: none;">
            <i class="fas fa-clock"></i> Time Remaining: <span id="time-remaining">0</span>s
          </div>
          
          <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          
          <div id="calibration-input" style="display: none;">
            <div class="form-group">
              <label for="calibration-value">Enter Calibration Value</label>
              <div class="input-group">
                <input type="number" id="calibration-value" class="form-control" step="0.01" placeholder="Expected value">
                <div class="input-group-append">
                  <span class="input-group-text" id="calibration-unit"></span>
                </div>
              </div>
              <small id="calibration-range" class="text-muted"></small>
            </div>
          </div>
          
          <button class="btn btn-primary" id="next-step-btn" onclick="nextCalibrationStep()" disabled>
            <i class="fas fa-play"></i> Start Calibration
          </button>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-history"></i> Calibration History</h2>
          </div>
          
          <div id="calibration-history">
            <p>No calibration records found</p>
          </div>
        </div>
      </div>
      
      <!-- Measurement Tab -->
      <div id="measurement" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-flask"></i> Take Measurements</h2>
            <div>
              <button class="btn btn-outline" onclick="showAutoMeasureModal()">
                <i class="fas fa-robot"></i> Auto Measure
              </button>
              <button class="btn btn-primary" onclick="logMeasurement()">
                <i class="fas fa-save"></i> Save
              </button>
            </div>
          </div>
          
          <div class="instruction-card">
            <h3><i class="fas fa-info-circle"></i> Proper Measurement Technique</h3>
            <ol>
              <li>Rinse probe with DI water</li>
              <li>Gently shake off excess water</li>
              <li>Immerse probe in sample</li>
              <li>Stir gently (for pH/DO measurements)</li>
              <li>Wait for reading to stabilize</li>
              <li>Record measurement</li>
            </ol>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <div class="form-group">
                <label for="measurement-parameter">Parameter</label>
                <select id="measurement-parameter" class="form-control" onchange="updateMeasurementFields()">
                  <option value="pH">pH</option>
                  <option value="DO">Dissolved Oxygen</option>
                  <option value="conductivity">Conductivity</option>
                  <option value="temperature">Temperature</option>
                  <option value="all">All Parameters</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="measurement-value">Value</label>
                <div class="input-group">
                  <input type="number" id="measurement-value" class="form-control" step="0.01" placeholder="Enter reading">
                  <div class="input-group-append">
                    <span class="input-group-text" id="measurement-unit">pH</span>
                  </div>
                </div>
                <small id="measurement-range" class="text-muted">Expected range: 0.0 to 14.0</small>
              </div>
            </div>
            
            <div>
              <div class="form-group">
                <label for="measurement-location">Location</label>
                <input type="text" id="measurement-location" class="form-control" placeholder="e.g., Site A, Pond 1">
              </div>
              
              <div class="form-group">
                <label for="measurement-notes">Notes</label>
                <textarea id="measurement-notes" class="form-control" rows="3" placeholder="Weather conditions, observations..."></textarea>
              </div>
            </div>
          </div>
          
          <div id="multi-parameter-fields" style="display: none; margin-top: 20px;">
            <h3 style="margin-bottom: 15px;">Multi-Parameter Measurements</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label for="ph-value">pH</label>
                <div class="input-group">
                  <input type="number" id="ph-value" class="form-control" step="0.01" placeholder="pH value">
                  <div class="input-group-append">
                    <span class="input-group-text">pH</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="do-value">Dissolved Oxygen</label>
                <div class="input-group">
                  <input type="number" id="do-value" class="form-control" step="0.01" placeholder="DO value">
                  <div class="input-group-append">
                    <span class="input-group-text">mg/L</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="cond-value">Conductivity</label>
                <div class="input-group">
                  <input type="number" id="cond-value" class="form-control" step="1" placeholder="Conductivity">
                  <div class="input-group-append">
                    <span class="input-group-text">µS/cm</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="temp-value">Temperature</label>
                <div class="input-group">
                  <input type="number" id="temp-value" class="form-control" step="0.1" placeholder="Temperature">
                  <div class="input-group-append">
                    <span class="input-group-text">°C</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> Measurement Trends</h2>
            <div>
              <select id="chart-timeframe" class="form-control" style="width: auto;" onchange="updateMeasurementChart()">
                <option value="1h">Last hour</option>
                <option value="6h">Last 6 hours</option>
                <option value="24h">Last 24 hours</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
                <option value="all">All data</option>
              </select>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="measurement-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Data Log Tab -->
      <div id="data" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-database"></i> Measurement Log</h2>
            <div>
              <button class="btn btn-outline" onclick="showExportModal()">
                <i class="fas fa-file-export"></i> Export
              </button>
              <button class="btn btn-warning" onclick="printMeasurements()">
                <i class="fas fa-print"></i> Print
              </button>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <div class="form-group" style="flex: 1;">
              <label for="data-filter">Filter by Parameter</label>
              <select id="data-filter" class="form-control" onchange="filterMeasurements()">
                <option value="all">All Parameters</option>
                <option value="pH">pH</option>
                <option value="DO">Dissolved Oxygen</option>
                <option value="conductivity">Conductivity</option>
                <option value="temperature">Temperature</option>
              </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
              <label for="date-filter">Date Range</label>
              <select id="date-filter" class="form-control" onchange="filterMeasurements()">
                <option value="all">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            
            <div id="custom-date-range" style="flex: 2; display: none; gap: 10px; align-items: flex-end;">
              <div class="form-group" style="flex: 1;">
                <label for="start-date">From</label>
                <input type="date" id="start-date" class="form-control" onchange="filterMeasurements()">
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="end-date">To</label>
                <input type="date" id="end-date" class="form-control" onchange="filterMeasurements()">
              </div>
            </div>
          </div>
          
          <div id="measurement-log">
            <p>No measurements recorded yet</p>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <div id="measurement-count">Showing 0 of 0 measurements</div>
            <div>
              <button class="btn btn-outline" id="prev-page" disabled onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <button class="btn btn-outline" id="next-page" disabled onclick="changePage(1)">
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Video Guides Tab -->
      <div id="videos" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-video"></i> Video Tutorials</h2>
            <button class="btn btn-outline" onclick="openTab('instructions')">
              <i class="fas fa-file-alt"></i> View Text Guides
            </button>
          </div>
          
          <div class="video-container">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/9HV7SpkgonM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
          <p><strong>Horiba U-52 Overview</strong> - Basic operation and maintenance</p>
          
          <div class="video-container">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/5w6s9K97G9g" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
          <p><strong>Calibration Guide</strong> - Step-by-step probe calibration</p>
          
          <div class="instruction-card">
            <h3><i class="fas fa-question-circle"></i> Need More Help?</h3>
            <p>Consult the <a href="https://www.horiba.com" target="_blank">Horiba Official Website</a> for:</p>
            <ul>
              <li>Technical specifications</li>
              <li>Manual downloads</li>
              <li>Support contacts</li>
              <li>Troubleshooting guides</li>
            </ul>
            <button class="btn btn-primary" onclick="showContactModal()">
              <i class="fas fa-envelope"></i> Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Floating Action Button -->
  <div class="floating-action-btn pulse" onclick="quickMeasurement('pH')" title="Quick pH Measurement">
    <i class="fas fa-water" style="font-size: 1.5rem;"></i>
  </div>
  
  <!-- Modals -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-cog"></i> Application Settings</h3>
        <button class="modal-close" onclick="hideModal('settings-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="unit-system">Unit System</label>
          <select id="unit-system" class="form-control">
            <option value="metric">Metric (°C, mg/L)</option>
            <option value="imperial">Imperial (°F, ppm)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="auto-save">Auto-save Measurements</label>
          <select id="auto-save" class="form-control">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="data-retention">Data Retention</label>
          <select id="data-retention" class="form-control">
            <option value="30">30 days</option>
            <option value="90">90 days</option>
            <option value="180">6 months</option>
            <option value="365">1 year</option>
            <option value="0">Keep forever</option>
          </select>
        </div>
        
        <div class="warning-card">
          <h3><i class="fas fa-exclamation-triangle"></i> Data Management</h3>
          <p>Clearing data cannot be undone. Export important measurements before clearing.</p>
          <button class="btn btn-danger" onclick="confirmClearData()">
            <i class="fas fa-trash"></i> Clear All Data
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideModal('settings-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="export-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-file-export"></i> Export Data</h3>
        <button class="modal-close" onclick="hideModal('export-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="export-format">Format</label>
          <select id="export-format" class="form-control">
            <option value="csv">CSV (Excel)</option>
            <option value="json">JSON</option>
            <option value="pdf">PDF Report</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="export-parameters">Parameters</label>
          <select id="export-parameters" class="form-control" multiple>
            <option value="pH" selected>pH</option>
            <option value="DO" selected>Dissolved Oxygen</option>
            <option value="conductivity" selected>Conductivity</option>
            <option value="temperature" selected>Temperature</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="export-date-range">Date Range</label>
          <select id="export-date-range" class="form-control">
            <option value="all">All Data</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        
        <div id="export-custom-range" style="display: none; gap: 10px; margin-top: 10px;">
          <div class="form-group" style="flex: 1;">
            <label for="export-start-date">From</label>
            <input type="date" id="export-start-date" class="form-control">
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="export-end-date">To</label>
            <input type="date" id="export-end-date" class="form-control">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideModal('export-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="exportData()">
          <i class="fas fa-download"></i> Export Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="contact-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-envelope"></i> Contact Support</h3>
        <button class="modal-close" onclick="hideModal('contact-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="contact-name">Your Name</label>
          <input type="text" id="contact-name" class="form-control">
        </div>
        
        <div class="form-group">
          <label for="contact-email">Email</label>
          <input type="email" id="contact-email" class="form-control">
        </div>
        
        <div class="form-group">
          <label for="contact-subject">Subject</label>
          <select id="contact-subject" class="form-control">
            <option value="technical">Technical Support</option>
            <option value="calibration">Calibration Help</option>
            <option value="data">Data Management</option>
            <option value="other">Other Inquiry</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="contact-message">Message</label>
          <textarea id="contact-message" class="form-control" rows="5"></textarea>
        </div>
        
        <div class="form-group">
          <label for="contact-attachment">Attach Screenshot (Optional)</label>
          <input type="file" id="contact-attachment" class="form-control" accept="image/*">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideModal('contact-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendSupportRequest()">
          <i class="fas fa-paper-plane"></i> Send Message
        </button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="auto-measure-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-robot"></i> Automatic Measurement</h3>
        <button class="modal-close" onclick="hideModal('auto-measure-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="instruction-card">
          <h3><i class="fas fa-info-circle"></i> How Auto-Measure Works</h3>
          <p>Connect to your Horiba U-52 device via Bluetooth to automatically record measurements at set intervals.</p>
        </div>
        
        <div class="form-group">
          <label for="auto-measure-parameters">Parameters to Measure</label>
          <select id="auto-measure-parameters" class="form-control" multiple>
            <option value="pH" selected>pH</option>
            <option value="DO" selected>Dissolved Oxygen</option>
            <option value="conductivity" selected>Conductivity</option>
            <option value="temperature" selected>Temperature</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="measurement-interval">Measurement Interval</label>
          <select id="measurement-interval" class="form-control">
            <option value="10">10 seconds</option>
            <option value="30">30 seconds</option>
            <option value="60">1 minute</option>
            <option value="300">5 minutes</option>
            <option value="600">10 minutes</option>
            <option value="1800">30 minutes</option>
            <option value="3600">1 hour</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="measurement-duration">Duration</label>
          <select id="measurement-duration" class="form-control">
            <option value="3600">1 hour</option>
            <option value="10800">3 hours</option>
            <option value="21600">6 hours</option>
            <option value="43200">12 hours</option>
            <option value="86400">24 hours</option>
            <option value="0">Until stopped</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="measurement-location-auto">Location</label>
          <input type="text" id="measurement-location-auto" class="form-control" placeholder="Enter location for all measurements">
        </div>
        
        <div class="warning-card" id="bluetooth-status">
          <h3><i class="fas fa-bluetooth-b"></i> Bluetooth Status: Not Connected</h3>
          <p>Connect to your Horiba U-52 device to enable automatic measurements.</p>
          <button class="btn btn-primary" onclick="connectBluetooth()">
            <i class="fas fa-bluetooth-b"></i> Connect Device
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideModal('auto-measure-modal')">Cancel</button>
        <button class="btn btn-success" id="start-auto-measure" disabled onclick="startAutoMeasure()">
          <i class="fas fa-play"></i> Start Auto-Measure
        </button>
      </div>
    </div>
  </div>
  
  <!-- Tour Elements -->
  <div class="tour-highlight" id="tour-highlight"></div>
  <div class="tour-tooltip" id="tour-tooltip">
    <div class="tour-tooltip-title" id="tour-tooltip-title"></div>
    <div id="tour-tooltip-content"></div>
    <div class="tour-tooltip-footer">
      <div class="tour-progress" id="tour-progress"></div>
      <div>
        <button class="btn btn-outline btn-sm" onclick="prevTourStep()">Back</button>
        <button class="btn btn-primary btn-sm" onclick="nextTourStep()">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    const state = {
      measurements: JSON.parse(localStorage.getItem('horibaMeasurements')) || [],
      calibrationHistory: JSON.parse(localStorage.getItem('horibaCalibrationHistory')) || [],
      settings: JSON.parse(localStorage.getItem('horibaSettings')) || {
        unitSystem: 'metric',
        autoSave: true,
        dataRetention: 30,
        lastTour: 0
      },
      currentCalibration: {
        parameter: null,
        step: 0,
        timer: null,
        maxTime: 0
      },
      filteredMeasurements: [],
      currentPage: 1,
      pageSize: 10,
      tour: {
        currentStep: 0,
        steps: [
          {
            target: '.header',
            title: 'Welcome to Horiba U-52 Field App',
            content: 'This app helps you calibrate, measure, and log water quality data with your Horiba U-52 meter.',
            position: 'bottom'
          },
          {
            target: '.tabs',
            title: 'Navigation Tabs',
            content: 'Switch between different app sections: Dashboard, Calibration, Measurement, Data Log, and Guides.',
            position: 'bottom'
          },
          {
            target: '#dashboard',
            title: 'Dashboard',
            content: 'Get an overview of recent measurements and sensor status at a glance.',
            position: 'right'
          },
          {
            target: '#calibration',
            title: 'Calibration',
            content: 'Calibrate your probes with step-by-step instructions and timers.',
            position: 'right'
          },
          {
            target: '#measurement',
            title: 'Measurement',
            content: 'Record water quality measurements and view trends over time.',
            position: 'right'
          },
          {
            target: '#data',
            title: 'Data Log',
            content: 'View, filter, and export all your recorded measurements.',
            position: 'right'
          },
          {
            target: '.floating-action-btn',
            title: 'Quick Actions',
            content: 'Take quick pH measurements with one tap using the floating button.',
            position: 'left'
          }
        ]
      },
      autoMeasure: {
        interval: null,
        timer: null,
        running: false
      }
    };
    
    // Calibration workflows with video references
    const calibrationWorkflows = {
      pH: {
        steps: [
          { 
            instruction: "Rinse pH probe thoroughly with deionized water", 
            duration: 30,
            expectedValue: null
          },
          { 
            instruction: "Immerse probe in pH 7 buffer solution (ensure bulb is fully submerged)", 
            duration: 120,
            expectedValue: 7.00
          },
          { 
            instruction: "Wait for reading to stabilize (stir gently if needed)", 
            duration: 60,
            expectedValue: null
          },
          { 
            instruction: "Enter the measured pH value (should be close to 7.00)", 
            duration: 0,
            expectedValue: 7.00,
            range: { min: 6.8, max: 7.2 }
          },
          { 
            instruction: "Rinse probe and immerse in second buffer (pH 4 or 10)", 
            duration: 120,
            expectedValue: null
          },
          { 
            instruction: "Wait for reading to stabilize", 
            duration: 60,
            expectedValue: null
          },
          { 
            instruction: "Enter the second buffer value (should match buffer)", 
            duration: 0,
            expectedValue: null,
            range: { min: 3.8, max: 10.2 }
          }
        ],
        videoId: "5w6s9K97G9g",
        videoStart: 120,
        unit: "pH"
      },
      DO: {
        steps: [
          { 
            instruction: "Prepare zero oxygen solution (5% sodium sulfite in DI water)", 
            duration: 60,
            expectedValue: null
          },
          { 
            instruction: "Immerse DO probe and wait for stabilization (no stirring)", 
            duration: 180,
            expectedValue: 0.00
          },
          { 
            instruction: "Confirm zero reading (should be 0.00 ±0.05 mg/L)", 
            duration: 0,
            expectedValue: 0.00,
            range: { min: -0.05, max: 0.05 }
          },
          { 
            instruction: "Rinse probe thoroughly with DI water", 
            duration: 30,
            expectedValue: null
          },
          { 
            instruction: "Expose probe to air (ensure membrane is moist)", 
            duration: 120,
            expectedValue: null
          },
          { 
            instruction: "Enter current air saturation value (use calibration table)", 
            duration: 0,
            expectedValue: null,
            range: { min: 7.0, max: 10.0 }
          }
        ],
        videoId: "5w6s9K97G9g",
        videoStart: 240,
        unit: "mg/L"
      },
      conductivity: {
        steps: [
          { 
            instruction: "Rinse conductivity probe with DI water", 
            duration: 30,
            expectedValue: null
          },
          { 
            instruction: "Immerse in standard solution (e.g., 1413 µS/cm at 25°C)", 
            duration: 120,
            expectedValue: 1413
          },
          { 
            instruction: "Wait for reading to stabilize (swirl gently)", 
            duration: 60,
            expectedValue: null
          },
          { 
            instruction: "Enter the measured conductivity value (should match standard)", 
            duration: 0,
            expectedValue: 1413,
            range: { min: 1350, max: 1470 }
          }
        ],
        videoId: "9HV7SpkgonM",
        videoStart: 180,
        unit: "µS/cm"
      },
      temperature: {
        steps: [
          { 
            instruction: "Prepare ice bath with crushed ice and DI water", 
            duration: 60,
            expectedValue: null
          },
          { 
            instruction: "Immerse temperature probe in ice bath (stir gently)", 
            duration: 120,
            expectedValue: 0.0
          },
          { 
            instruction: "Confirm 0°C reading (should be 0.0 ±0.1°C)", 
            duration: 0,
            expectedValue: 0.0,
            range: { min: -0.1, max: 0.1 }
          },
          { 
            instruction: "Transfer to boiling water (caution: use protective gear)", 
            duration: 120,
            expectedValue: null
          },
          { 
            instruction: "Confirm boiling point reading (adjust for altitude)", 
            duration: 0,
            expectedValue: null,
            range: { min: 95, max: 100 }
          }
        ],
        videoId: "9HV7SpkgonM",
        videoStart: 300,
        unit: "°C"
      }
    };
    
    // Parameter metadata
    const parameterMetadata = {
      pH: {
        name: "pH",
        unit: "pH",
        min: 0,
        max: 14,
        decimals: 2,
        icon: "fa-water",
        color: "#4bc0c0"
      },
      DO: {
        name: "Dissolved Oxygen",
        unit: "mg/L",
        min: 0,
        max: 20,
        decimals: 2,
        icon: "fa-wind",
        color: "#ff6384"
      },
      conductivity: {
        name: "Conductivity",
        unit: "µS/cm",
        min: 0,
        max: 20000,
        decimals: 0,
        icon: "fa-bolt",
        color: "#36a2eb"
      },
      temperature: {
        name: "Temperature",
        unit: "°C",
        min: -10,
        max: 100,
        decimals: 1,
        icon: "fa-thermometer-half",
        color: "#ff9f40"
      }
    };
    
    // Initialize the application
    function initApp() {
      // Load settings
      loadSettings();
      
      // Set up event listeners
      document.getElementById('date-filter').addEventListener('change', function() {
        if (this.value === 'custom') {
          document.getElementById('custom-date-range').style.display = 'flex';
          const today = new Date();
          document.getElementById('start-date').valueAsDate = new Date(today.setDate(today.getDate() - 7));
          document.getElementById('end-date').valueAsDate = new Date();
        } else {
          document.getElementById('custom-date-range').style.display = 'none';
        }
        filterMeasurements();
      });
      
      document.getElementById('export-date-range').addEventListener('change', function() {
        if (this.value === 'custom') {
          document.getElementById('export-custom-range').style.display = 'flex';
          const today = new Date();
          document.getElementById('export-start-date').valueAsDate = new Date(today.setDate(today.getDate() - 7));
          document.getElementById('export-end-date').valueAsDate = new Date();
        } else {
          document.getElementById('export-custom-range').style.display = 'none';
        }
      });
      
      // Initialize charts
      initDashboardChart();
      initMeasurementChart();
      
      // Update UI
      updateMeasurementBadge();
      renderCalibrationHistory();
      
      // Check if first run or need tour
      const now = new Date().getTime();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      if (!state.settings.lastTour || now - state.settings.lastTour > oneWeek) {
        setTimeout(() => {
          if (confirm("Welcome to the Horiba U-52 Field App! Would you like a quick tour of the features?")) {
            startTour();
          }
          state.settings.lastTour = now;
          saveSettings();
        }, 1000);
      }
    }
    
    // Tab navigation
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`).classList.add('active');
      
      // Special tab handling
      if (tabId === 'data') {
        filterMeasurements();
      } else if (tabId === 'measurement') {
        updateMeasurementChart();
      } else if (tabId === 'dashboard') {
        updateDashboardChart();
      }
    }
    
    // Calibration functions
    function updateCalibrationSteps() {
      const parameter = document.getElementById('calibration-parameter').value;
      if (!parameter) return;
      
      state.currentCalibration.parameter = parameter;
      state.currentCalibration.step = 0;
      
      const workflow = calibrationWorkflows[parameter];
      const stepsContainer = document.getElementById('calibration-steps');
      
      stepsContainer.innerHTML = `
        <h3><i class="fas fa-sliders-h"></i> ${parameter} Calibration</h3>
        <p>${workflow.steps[0].instruction}</p>
        <div class="warning-card">
          <h3><i class="fas fa-exclamation-triangle"></i> Important</h3>
          <p>Ensure you have fresh calibration solutions ready. Watch the <a href="#videos" onclick="openTab('videos')">video guide</a> for visual instructions.</p>
        </div>
      `;
      
      // Show relevant video
      const videoContainer = document.getElementById('calibration-video');
      videoContainer.style.display = 'block';
      videoContainer.innerHTML = `
        <iframe width="560" height="315" src="https://www.youtube.com/embed/${workflow.videoId}?start=${workflow.videoStart}" 
        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      `;
      
      document.getElementById('next-step-btn').disabled = false;
      document.getElementById('next-step-btn').innerHTML = '<i class="fas fa-play"></i> Start Step';
      document.getElementById('timer-display').style.display = 'none';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('calibration-input').style.display = 'none';
      
      // Set expected unit
      document.getElementById('calibration-unit').textContent = workflow.unit;
    }
    
    function nextCalibrationStep() {
      const parameter = state.currentCalibration.parameter;
      const step = state.currentCalibration.step;
      const workflow = calibrationWorkflows[parameter];
      
      // If we're at a step that requires input
      if (step > 0 && workflow.steps[step-1].expectedValue !== null && !validateCalibrationInput()) {
        return;
      }
      
      // If we're at the last step, complete calibration
      if (step >= workflow.steps.length - 1) {
        completeCalibration();
        return;
      }
      
      // Start timer for current step if duration > 0
      const duration = workflow.steps[step].duration;
      if (duration > 0) {
        startTimer(duration);
      } else {
        // Show input field if this step requires a value
        if (workflow.steps[step].expectedValue !== null) {
          showCalibrationInput(workflow.steps[step]);
        }
      }
      
      // Update UI for next step
      state.currentCalibration.step++;
      document.getElementById('calibration-steps').innerHTML = `
        <h3>Step ${state.currentCalibration.step + 1} of ${workflow.steps.length}</h3>
        <p>${workflow.steps[state.currentCalibration.step].instruction}</p>
      `;
      
      if (state.currentCalibration.step >= workflow.steps.length - 1) {
        document.getElementById('next-step-btn').innerHTML = '<i class="fas fa-check"></i> Complete Calibration';
      } else {
        document.getElementById('next-step-btn').innerHTML = '<i class="fas fa-forward"></i> Next Step';
      }
    }
    
    function showCalibrationInput(step) {
      const inputDiv = document.getElementById('calibration-input');
      inputDiv.style.display = 'block';
      
      const input = document.getElementById('calibration-value');
      input.value = step.expectedValue || '';
      
      const rangeInfo = document.getElementById('calibration-range');
      if (step.range) {
        rangeInfo.textContent = `Expected range: ${step.range.min} to ${step.range.max}`;
      } else {
        rangeInfo.textContent = '';
      }
      
      document.getElementById('next-step-btn').disabled = true;
    }
    
    function validateCalibrationInput() {
      const parameter = state.currentCalibration.parameter;
      const step = state.currentCalibration.step - 1; // Current step is already incremented
      const workflow = calibrationWorkflows[parameter];
      const stepConfig = workflow.steps[step];
      
      const inputValue = parseFloat(document.getElementById('calibration-value').value);
      
      if (isNaN(inputValue)) {
        alert('Please enter a valid number');
        return false;
      }
      
      if (stepConfig.range && (inputValue < stepConfig.range.min || inputValue > stepConfig.range.max)) {
        alert(`Value should be between ${stepConfig.range.min} and ${stepConfig.range.max}`);
        return false;
      }
      
      document.getElementById('next-step-btn').disabled = false;
      return true;
    }
    
    function startTimer(seconds) {
      // Clear any existing timer
      if (state.currentCalibration.timer) {
        clearInterval(state.currentCalibration.timer);
      }
      
      state.currentCalibration.maxTime = seconds;
      let remaining = seconds;
      
      // Show timer UI
      document.getElementById('timer-display').style.display = 'block';
      document.getElementById('progress-container').style.display = 'block';
      document.getElementById('calibration-input').style.display = 'none';
      
      // Update timer display immediately
      document.getElementById('time-remaining').textContent = remaining;
      document.getElementById('progress-bar').style.width = '0%';
      
      // Update timer every second
      state.currentCalibration.timer = setInterval(() => {
        remaining--;
        document.getElementById('time-remaining').textContent = remaining;
        const percent = ((state.currentCalibration.maxTime - remaining) / state.currentCalibration.maxTime) * 100;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        
        if (remaining <= 0) {
          clearInterval(state.currentCalibration.timer);
          document.getElementById('next-step-btn').disabled = false;
        }
      }, 1000);
      
      document.getElementById('next-step-btn').disabled = true;
    }
    
    function completeCalibration() {
      const parameter = state.currentCalibration.parameter;
      const workflow = calibrationWorkflows[parameter];
      const now = new Date();
      
      // Add to calibration history
      const calibrationRecord = {
        parameter,
        timestamp: now,
        values: []
      };
      
      // Collect all input values
      for (let i = 0; i < workflow.steps.length; i++) {
        if (workflow.steps[i].expectedValue !== null) {
          calibrationRecord.values.push({
            expected: workflow.steps[i].expectedValue,
            actual: i === state.currentCalibration.step - 1 ? 
              parseFloat(document.getElementById('calibration-value').value) : null
          });
        }
      }
      
      state.calibrationHistory.push(calibrationRecord);
      localStorage.setItem('horibaCalibrationHistory', JSON.stringify(state.calibrationHistory));
      
      // Update status display
      updateSensorStatus(parameter, now);
      
      // Reset calibration UI
      document.getElementById('calibration-steps').innerHTML = `
        <div class="success-card">
          <h3><i class="fas fa-check-circle"></i> ${parameter} Calibration Complete!</h3>
          <p>Calibration performed at ${now.toLocaleTimeString()} on ${now.toLocaleDateString()}</p>
          <p>Proceed to <a href="#measurement" onclick="openTab('measurement')">measurement</a> or <a href="#videos" onclick="openTab('videos')">watch more videos</a></p>
        </div>
      `;
      
      document.getElementById('next-step-btn').disabled = true;
      document.getElementById('timer-display').style.display = 'none';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('calibration-video').style.display = 'none';
      document.getElementById('calibration-input').style.display = 'none';
      
      // Show success notification
      showNotification(`${parameter} calibration completed successfully!`, 'success');
      
      // Update calibration history display
      renderCalibrationHistory();
    }
    
    function updateSensorStatus(parameter, timestamp) {
      const elapsed = Math.floor((new Date() - timestamp) / (1000 * 60)); // Minutes since calibration
      let statusText, statusClass;
      
      // Determine status based on time since calibration
      if (elapsed < 120) { // 2 hours
        statusText = `Calibrated ${elapsed} minute${elapsed !== 1 ? 's' : ''} ago`;
        statusClass = 'status-good';
      } else if (elapsed < 1440) { // 24 hours
        const hours = Math.floor(elapsed / 60);
        statusText = `Calibrated ${hours} hour${hours !== 1 ? 's' : ''} ago`;
        statusClass = parameter === 'DO' ? 'status-warning' : 'status-good';
      } else {
        const days = Math.floor(elapsed / 1440);
        statusText = `Calibrated ${days} day${days !== 1 ? 's' : ''} ago`;
        statusClass = 'status-warning';
      }
      
      // Update UI
      const elementId = `${parameter.toLowerCase()}-status`;
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = statusText;
        // Update status indicator
        const indicator = element.previousElementSibling;
        if (indicator) {
          indicator.className = 'status-indicator ' + statusClass;
        }
      }
    }
    
    function renderCalibrationHistory() {
      const container = document.getElementById('calibration-history');
      
      if (state.calibrationHistory.length === 0) {
        container.innerHTML = '<p>No calibration records found</p>';
        return;
      }
      
      // Group by parameter
      const grouped = {};
      state.calibrationHistory.forEach(record => {
        if (!grouped[record.parameter]) {
          grouped[record.parameter] = [];
        }
        grouped[record.parameter].push(record);
      });
      
      let html = '';
      for (const param in grouped) {
        const meta = parameterMetadata[param];
        html += `
          <div class="card" style="margin-bottom: 15px;">
            <div class="card-header">
              <h3><i class="fas ${meta.icon}"></i> ${param} Calibrations</h3>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 1px solid #eee;">
                    <th style="padding: 10px; text-align: left;">Date</th>
                    <th style="padding: 10px; text-align: left;">Values</th>
                  </tr>
                </thead>
                <tbody>
                  ${grouped[param].map(record => `
                    <tr style="border-bottom: 1px solid #eee;">
                      <td style="padding: 10px;">
                        ${new Date(record.timestamp).toLocaleString()}
                      </td>
                      <td style="padding: 10px;">
                        ${record.values.map(val => `
                          <div>Expected: ${val.expected} ${meta.unit}, Actual: ${val.actual !== null ? val.actual : 'N/A'}</div>
                        `).join('')}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // Measurement functions
    function updateMeasurementFields() {
      const param = document.getElementById('measurement-parameter').value;
      
      if (param === 'all') {
        document.getElementById('multi-parameter-fields').style.display = 'block';
        document.getElementById('measurement-value').style.display = 'none';
        document.querySelector('label[for="measurement-value"]').style.display = 'none';
      } else {
        document.getElementById('multi-parameter-fields').style.display = 'none';
        document.getElementById('measurement-value').style.display = 'block';
        document.querySelector('label[for="measurement-value"]').style.display = 'block';
        
        const meta = parameterMetadata[param];
        document.getElementById('measurement-unit').textContent = meta.unit;
        document.getElementById('measurement-range').textContent = `Expected range: ${meta.min} to ${meta.max}`;
        document.getElementById('measurement-value').step = 1 / Math.pow(10, meta.decimals);
      }
    }
    
    function validateMeasurement(parameter, value) {
      const validations = {
        pH: { min: 0, max: 14, decimals: 2 },
        DO: { min: 0, max: 20, decimals: 2 },
        conductivity: { min: 0, max: 20000, decimals: 0 },
        temperature: { min: -10, max: 100, decimals: 1 }
      };
      
      const config = validations[parameter];
      const rounded = parseFloat(value.toFixed(config.decimals));
      
      if (rounded < config.min || rounded > config.max) {
        throw new Error(`Value must be between ${config.min} and ${config.max}`);
      }
      
      return rounded;
    }
    
    function logMeasurement() {
      const param = document.getElementById('measurement-parameter').value;
      const location = document.getElementById('measurement-location').value;
      const notes = document.getElementById('measurement-notes').value;
      
      if (param === 'all') {
        // Multi-parameter measurement
        const phValue = document.getElementById('ph-value').value;
        const doValue = document.getElementById('do-value').value;
        const condValue = document.getElementById('cond-value').value;
        const tempValue = document.getElementById('temp-value').value;
        
        if (!phValue && !doValue && !condValue && !tempValue) {
          showNotification('Please enter at least one measurement value', 'warning');
          return;
        }
        
        const timestamp = new Date();
        
        if (phValue) {
          try {
            const value = validateMeasurement('pH', parseFloat(phValue));
            state.measurements.push({
              id: timestamp.getTime() + 1,
              timestamp,
              parameter: 'pH',
              value,
              location,
              notes,
              unit: 'pH'
            });
          } catch (e) {
            showNotification(`pH Error: ${e.message}`, 'danger');
          }
        }
        
        if (doValue) {
          try {
            const value = validateMeasurement('DO', parseFloat(doValue));
            state.measurements.push({
              id: timestamp.getTime() + 2,
              timestamp,
              parameter: 'DO',
              value,
              location,
              notes,
              unit: 'mg/L'
            });
          } catch (e) {
            showNotification(`DO Error: ${e.message}`, 'danger');
          }
        }
        
        if (condValue) {
          try {
            const value = validateMeasurement('conductivity', parseFloat(condValue));
            state.measurements.push({
              id: timestamp.getTime() + 3,
              timestamp,
              parameter: 'conductivity',
              value,
              location,
              notes,
              unit: 'µS/cm'
            });
          } catch (e) {
            showNotification(`Conductivity Error: ${e.message}`, 'danger');
          }
        }
        
        if (tempValue) {
          try {
            const value = validateMeasurement('temperature', parseFloat(tempValue));
            state.measurements.push({
              id: timestamp.getTime() + 4,
              timestamp,
              parameter: 'temperature',
              value,
              location,
              notes,
              unit: '°C'
            });
          } catch (e) {
            showNotification(`Temperature Error: ${e.message}`, 'danger');
          }
        }
      } else {
        // Single parameter measurement
        const valueInput = document.getElementById('measurement-value');
        const value = parseFloat(valueInput.value);
        
        if (isNaN(value)) {
          showNotification('Please enter a valid measurement value', 'warning');
          return;
        }
        
        try {
          const validatedValue = validateMeasurement(param, value);
          const meta = parameterMetadata[param];
          
          state.measurements.push({
            id: new Date().getTime(),
            timestamp: new Date(),
            parameter: param,
            value: validatedValue,
            location,
            notes,
            unit: meta.unit
          });
        } catch (e) {
          showNotification(`Error: ${e.message}`, 'danger');
          return;
        }
        
        // Clear single value input
        valueInput.value = '';
      }
      
      // Clear common fields
      document.getElementById('measurement-location').value = '';
      document.getElementById('measurement-notes').value = '';
      
      // Clear multi-parameter fields
      document.getElementById('ph-value').value = '';
      document.getElementById('do-value').value = '';
      document.getElementById('cond-value').value = '';
      document.getElementById('temp-value').value = '';
      
      // Save to localStorage
      localStorage.setItem('horibaMeasurements', JSON.stringify(state.measurements));
      
      // Update UI
      updateMeasurementChart();
      updateMeasurementBadge();
      
      // Auto-switch to data tab if not already there
      if (!document.getElementById('data').classList.contains('active')) {
        openTab('data');
      } else {
        filterMeasurements();
      }
      
      showNotification('Measurement recorded successfully!', 'success');
    }

function updateRecentMeasurements() {
  const container = document.querySelector('#dashboard .chart-container').previousElementSibling;
  
  // Get last 5 measurements
  const recent = [...state.measurements]
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, 5);
  
  if (recent.length === 0) {
    container.innerHTML = '<p>No recent measurements found</p>';
    return;
  }
  
  container.innerHTML = `
    <div class="measurement-grid">
      ${recent.map(m => `
        <div class="measurement-item">
          <div class="measurement-meta">
            <span><i class="fas ${parameterMetadata[m.parameter].icon}"></i> ${m.parameter}</span>
            <span>${new Date(m.timestamp).toLocaleString()}</span>
          </div>
          <div class="measurement-value">${m.value} ${m.unit}</div>
          ${m.location ? `<div><i class="fas fa-map-marker-alt"></i> ${m.location}</div>` : ''}
        </div>
      `).join('')}
    </div>
  `;
}
    
    function quickMeasurement(param) {
      openTab('measurement');
      document.getElementById('measurement-parameter').value = param;
      updateMeasurementFields();
      document.getElementById('measurement-value').focus();
      
      // Pulse the measurement value field
      const field = document.getElementById('measurement-value');
      field.classList.add('pulse');
      setTimeout(() => {
        field.classList.remove('pulse');
      }, 2000);
    }
    
    // Data log functions
    function filterMeasurements() {
      const paramFilter = document.getElementById('data-filter').value;
      const dateFilter = document.getElementById('date-filter').value;
      
      // Filter by parameter
      state.filteredMeasurements = paramFilter === 'all' 
        ? [...state.measurements] 
        : state.measurements.filter(m => m.parameter === paramFilter);
      
      // Filter by date
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date(today);
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      
      if (dateFilter === 'today') {
        state.filteredMeasurements = state.filteredMeasurements.filter(m => 
          new Date(m.timestamp) >= today
        );
      } else if (dateFilter === 'week') {
        state.filteredMeasurements = state.filteredMeasurements.filter(m => 
          new Date(m.timestamp) >= weekAgo
        );
      } else if (dateFilter === 'month') {
        state.filteredMeasurements = state.filteredMeasurements.filter(m => 
          new Date(m.timestamp) >= monthAgo
        );
      } else if (dateFilter === 'custom') {
        const startDate = new Date(document.getElementById('start-date').value);
        const endDate = new Date(document.getElementById('end-date').value);
        
        if (startDate && endDate) {
          state.filteredMeasurements = state.filteredMeasurements.filter(m => {
            const date = new Date(m.timestamp);
            return date >= startDate && date <= endDate;
          });
        }
      }
      
      // Sort by date (newest first)
      state.filteredMeasurements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // Reset to first page
      state.currentPage = 1;
      
      // Render results
      renderMeasurementLog();
    }
    
    function renderMeasurementLog() {
      const container = document.getElementById('measurement-log');
      
      if (state.filteredMeasurements.length === 0) {
        container.innerHTML = '<p>No measurements found matching your criteria</p>';
        document.getElementById('measurement-count').textContent = 'Showing 0 of 0 measurements';
        document.getElementById('prev-page').disabled = true;
        document.getElementById('next-page').disabled = true;
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(state.filteredMeasurements.length / state.pageSize);
      const startIdx = (state.currentPage - 1) * state.pageSize;
      const endIdx = Math.min(startIdx + state.pageSize, state.filteredMeasurements.length);
      const paginated = state.filteredMeasurements.slice(startIdx, endIdx);
      
      // Update pagination controls
      document.getElementById('prev-page').disabled = state.currentPage <= 1;
      document.getElementById('next-page').disabled = state.currentPage >= totalPages;
      document.getElementById('measurement-count').textContent = 
        `Showing ${startIdx + 1}-${endIdx} of ${state.filteredMeasurements.length} measurements`;
      
      // Render measurements
      container.innerHTML = paginated.map(m => `
        <div class="measurement-item">
          <div class="measurement-meta">
            <span><i class="fas ${parameterMetadata[m.parameter].icon}"></i> ${m.parameter}</span>
            <span>${new Date(m.timestamp).toLocaleString()}</span>
          </div>
          <div class="measurement-value">${m.value} ${m.unit}</div>
          ${m.location ? `<div><i class="fas fa-map-marker-alt"></i> ${m.location}</div>` : ''}
          ${m.notes ? `<div style="margin-top: 10px;">${m.notes}</div>` : ''}
          <div class="measurement-actions">
            <button class="btn btn-outline" onclick="editMeasurement(${m.id})">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-danger" onclick="deleteMeasurement(${m.id})">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function changePage(delta) {
      const newPage = state.currentPage + delta;
      const totalPages = Math.ceil(state.filteredMeasurements.length / state.pageSize);
      
      if (newPage > 0 && newPage <= totalPages) {
        state.currentPage = newPage;
        renderMeasurementLog();
        
        // Scroll to top of log
        document.getElementById('measurement-log').scrollIntoView({
          behavior: 'smooth'
        });
      }
    }
    
    function editMeasurement(id) {
      const measurement = state.measurements.find(m => m.id === id);
      if (!measurement) return;
      
      openTab('measurement');
      
      // Set form values
      document.getElementById('measurement-parameter').value = measurement.parameter;
      document.getElementById('measurement-value').value = measurement.value;
      document.getElementById('measurement-location').value = measurement.location || '';
      document.getElementById('measurement-notes').value = measurement.notes || '';
      
      // Update fields
      updateMeasurementFields();
      
      // Show notification
      showNotification('Editing existing measurement. Update values and save to update.', 'info');
      
      // Delete the old measurement when saving
      // We'll handle this in the logMeasurement function by checking for an existing ID
    }
    
    function deleteMeasurement(id) {
      if (confirm('Are you sure you want to delete this measurement?')) {
        state.measurements = state.measurements.filter(m => m.id !== id);
        localStorage.setItem('horibaMeasurements', JSON.stringify(state.measurements));
        
        // Update filtered measurements if needed
        const idx = state.filteredMeasurements.findIndex(m => m.id === id);
        if (idx !== -1) {
          state.filteredMeasurements.splice(idx, 1);
        }
        
        renderMeasurementLog();
        updateMeasurementChart();
        updateDashboardChart();
        updateMeasurementBadge();
        
        showNotification('Measurement deleted', 'success');
      }
    }
    
    function showExportModal() {
      document.getElementById('export-modal').classList.add('active');
    }
    
    function exportData() {
      const format = document.getElementById('export-format').value;
      const params = Array.from(document.getElementById('export-parameters').selectedOptions)
        .map(opt => opt.value);
      const dateRange = document.getElementById('export-date-range').value;
      
      // Filter measurements
      let measurementsToExport = state.measurements;
      
      // Filter by parameters
      if (!params.includes('all')) {
        measurementsToExport = measurementsToExport.filter(m => params.includes(m.parameter));
      }
      
      // Filter by date range
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date(today);
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      
      if (dateRange === 'today') {
        measurementsToExport = measurementsToExport.filter(m => 
          new Date(m.timestamp) >= today
        );
      } else if (dateRange === 'week') {
        measurementsToExport = measurementsToExport.filter(m => 
          new Date(m.timestamp) >= weekAgo
        );
      } else if (dateRange === 'month') {
        measurementsToExport = measurementsToExport.filter(m => 
          new Date(m.timestamp) >= monthAgo
        );
      } else if (dateRange === 'custom') {
        const startDate = new Date(document.getElementById('export-start-date').value);
        const endDate = new Date(document.getElementById('export-end-date').value);
        
        if (startDate && endDate) {
          measurementsToExport = measurementsToExport.filter(m => {
            const date = new Date(m.timestamp);
            return date >= startDate && date <= endDate;
          });
        }
      }
      
      // Sort by date
      measurementsToExport.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      if (measurementsToExport.length === 0) {
        showNotification('No measurements match your export criteria', 'warning');
        return;
      }
      
      if (format === 'csv') {
        exportToCSV(measurementsToExport);
      } else if (format === 'json') {
        exportToJSON(measurementsToExport);
      } else {
        // PDF would require a library like jsPDF or a server component
        showNotification('PDF export requires additional setup', 'info');
      }
      
      hideModal('export-modal');
    }
    
    function exportToCSV(measurements) {
      // Convert to CSV
      const headers = ['Timestamp', 'Parameter', 'Value', 'Unit', 'Location', 'Notes'];
      const rows = measurements.map(m => [
        m.timestamp,
        m.parameter,
        m.value,
        m.unit,
        m.location || '',
        m.notes || ''
      ]);
      
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `horiba_measurements_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showNotification('CSV exported successfully', 'success');
    }
    
    function exportToJSON(measurements) {
      const json = JSON.stringify(measurements, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `horiba_measurements_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showNotification('JSON exported successfully', 'success');
    }
    
    function printMeasurements() {
      const printWindow = window.open('', '_blank');
      const paramFilter = document.getElementById('data-filter').value;
      const dateFilter = document.getElementById('date-filter').value;
      
      let filtered = [...state.measurements];
      
      // Apply the same filters as the current view
      if (paramFilter !== 'all') {
        filtered = filtered.filter(m => m.parameter === paramFilter);
      }
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date(today);
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      
      if (dateFilter === 'today') {
        filtered = filtered.filter(m => new Date(m.timestamp) >= today);
      } else if (dateFilter === 'week') {
        filtered = filtered.filter(m => new Date(m.timestamp) >= weekAgo);
      } else if (dateFilter === 'month') {
        filtered = filtered.filter(m => new Date(m.timestamp) >= monthAgo);
      } else if (dateFilter === 'custom') {
        const startDate = new Date(document.getElementById('start-date').value);
        const endDate = new Date(document.getElementById('end-date').value);
        
        if (startDate && endDate) {
          filtered = filtered.filter(m => {
            const date = new Date(m.timestamp);
            return date >= startDate && date <= endDate;
          });
        }
      }
      
      // Sort by date
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      printWindow.document.write(`
        <html>
          <head>
            <title>Horiba U-52 Measurement Report</title>
            <style>
              body { font-family: Arial; margin: 20px; }
              h1 { color: #0066cc; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
              .footer { margin-top: 20px; font-size: 0.8em; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Horiba U-52 Measurement Report</h1>
              <div>
                <p>Generated: ${new Date().toLocaleString()}</p>
                <p>Parameters: ${paramFilter === 'all' ? 'All' : paramFilter}</p>
              </div>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Parameter</th>
                  <th>Value</th>
                  <th>Unit</th>
                  <th>Location</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                ${filtered.map(m => `
                  <tr>
                    <td>${new Date(m.timestamp).toLocaleString()}</td>
                    <td>${m.parameter}</td>
                    <td>${m.value}</td>
                    <td>${m.unit}</td>
                    <td>${m.location || ''}</td>
                    <td>${m.notes || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div class="footer">
              <p>Total measurements: ${filtered.length}</p>
              <p>Report generated by Horiba U-52 Field App</p>
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    }
    
    // Chart functions
    function initDashboardChart() {
      const ctx = document.getElementById('dashboard-chart').getContext('2d');
      
      window.dashboardChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            createDatasetConfig('pH'),
            createDatasetConfig('DO'),
            createDatasetConfig('conductivity'),
            createDatasetConfig('temperature')
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                tooltipFormat: 'MMM d, yyyy h:mm a'
              },
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Value'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed.y + ' ' + parameterMetadata[context.dataset.parameter].unit;
                  return label;
                }
              }
            }
          }
        }
      });
      
      updateDashboardChart();
    }
    
function updateDashboardChart() {
  if (!window.dashboardChart) return;
  
  // Get last 10 measurements for each parameter (or adjust as needed)
  const recentMeasurements = [...state.measurements]
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, 40); // Show last 10 measurements per parameter (4 parameters)
  
  // Group measurements by parameter
  const measurementsByParam = {
    pH: [],
    DO: [],
    conductivity: [],
    temperature: []
  };
  
  recentMeasurements.forEach(m => {
    if (measurementsByParam[m.parameter]) {
      measurementsByParam[m.parameter].push(m);
    }
  });
  
  // Update each dataset
  window.dashboardChart.data.datasets.forEach(dataset => {
    const param = dataset.parameter;
    dataset.data = measurementsByParam[param].map(m => ({
      x: new Date(m.timestamp),
      y: m.value
    }));
  });
  
  window.dashboardChart.update();
}
    
    function initMeasurementChart() {
      const ctx = document.getElementById('measurement-chart').getContext('2d');
      
      window.measurementChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'MMM d, yyyy h:mm a'
              },
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Value'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            annotation: {
              annotations: {
                line1: {
                  type: 'line',
                  yMin: 7,
                  yMax: 7,
                  borderColor: 'rgb(75, 192, 192)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: 'Neutral pH',
                    enabled: true,
                    position: 'right'
                  }
                },
                line2: {
                  type: 'line',
                  yMin: 8,
                  yMax: 8,
                  borderColor: 'rgb(255, 99, 132)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: 'DO Saturation',
                    enabled: true,
                    position: 'right'
                  }
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed.y + ' ' + parameterMetadata[context.dataset.parameter].unit;
                  return label;
                }
              }
            }
          }
        }
      });
      
      updateMeasurementChart();
    }
    
function updateMeasurementChart() {
  if (!window.measurementChart) return;
  
  const selectedParam = document.getElementById('measurement-parameter').value;
  const timeframe = document.getElementById('chart-timeframe').value;
  
  // Calculate cutoff based on timeframe
  let cutoff = new Date(0); // Default to all data
  const now = new Date();
  
  if (timeframe === '1h') {
    cutoff = new Date(now.getTime() - 3600000);
  } else if (timeframe === '6h') {
    cutoff = new Date(now.getTime() - 6 * 3600000);
  } else if (timeframe === '24h') {
    cutoff = new Date(now.getTime() - 24 * 3600000);
  } else if (timeframe === '7d') {
    cutoff = new Date(now.getTime() - 7 * 24 * 3600000);
  } else if (timeframe === '30d') {
    cutoff = new Date(now.getTime() - 30 * 24 * 3600000);
  }
  
  // Filter measurements
  let filtered = state.measurements.filter(m => new Date(m.timestamp) > cutoff);
  
  if (selectedParam !== 'all') {
    filtered = filtered.filter(m => m.parameter === selectedParam);
  }
  
  // Group by parameter for charting
  const datasets = [];
  const params = [...new Set(filtered.map(m => m.parameter))];
  
  params.forEach(param => {
    const paramMeasurements = filtered.filter(m => m.parameter === param);
    datasets.push({
      label: parameterMetadata[param].name,  // Changed from paramMetadata to parameterMetadata
      data: paramMeasurements.map(m => ({
        x: new Date(m.timestamp),
        y: m.value
      })),
      borderColor: parameterMetadata[param].color,  // Changed from paramMetadata to parameterMetadata
      backgroundColor: 'rgba(0,0,0,0.1)',
      tension: 0.1,
      parameter: param
    });
  });
  
  // Update chart
  window.measurementChart.data.datasets = datasets;
  window.measurementChart.update();
}
    
    function createDatasetConfig(param) {
      const meta = parameterMetadata[param];
      return {
        label: meta.name,
        data: [],
        borderColor: meta.color,
        backgroundColor: hexToRgba(meta.color, 0.1),
        tension: 0.1,
        fill: true,
        pointRadius: 3,
        pointHoverRadius: 5,
        parameter: param
      };
    }
    
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // Settings functions
    function showSettingsModal() {
      // Load current settings into modal
      document.getElementById('unit-system').value = state.settings.unitSystem;
      document.getElementById('auto-save').value = state.settings.autoSave;
      document.getElementById('data-retention').value = state.settings.dataRetention;
      
      document.getElementById('settings-modal').classList.add('active');
    }
    
    function saveSettings() {
      state.settings.unitSystem = document.getElementById('unit-system').value;
      state.settings.autoSave = document.getElementById('auto-save').value === 'true';
      state.settings.dataRetention = parseInt(document.getElementById('data-retention').value);
      
      localStorage.setItem('horibaSettings', JSON.stringify(state.settings));
      
      // Apply unit system changes
      if (state.settings.unitSystem === 'imperial') {
        // Convert temperature to Fahrenheit
        state.measurements.forEach(m => {
          if (m.parameter === 'temperature') {
            m.value = (m.value * 9/5) + 32;
            m.unit = '°F';
          }
        });
      } else {
        // Convert back to metric
        state.measurements.forEach(m => {
          if (m.parameter === 'temperature') {
            m.value = (m.value - 32) * 5/9;
            m.unit = '°C';
          }
        });
      }
      
      localStorage.setItem('horibaMeasurements', JSON.stringify(state.measurements));
      
      // Update UI
      updateMeasurementChart();
      updateDashboardChart();
      filterMeasurements();
      
      hideModal('settings-modal');
      showNotification('Settings saved successfully', 'success');
    }
    
    function confirmClearData() {
      if (confirm('Are you sure you want to delete ALL measurement data? This cannot be undone.')) {
        state.measurements = [];
        localStorage.setItem('horibaMeasurements', JSON.stringify(state.measurements));
        
        state.filteredMeasurements = [];
        renderMeasurementLog();
        updateMeasurementChart();
        updateDashboardChart();
        updateMeasurementBadge();
        
        showNotification('All measurement data has been cleared', 'success');
      }
    }
    
    // Auto-measurement functions
    function showAutoMeasureModal() {
      document.getElementById('auto-measure-modal').classList.add('active');
    }
    
    function connectBluetooth() {
      // This is a mock implementation - actual Bluetooth would require Web Bluetooth API
      showNotification('Connecting to Horiba U-52 via Bluetooth...', 'info');
      
      setTimeout(() => {
        document.getElementById('bluetooth-status').innerHTML = `
          <h3><i class="fas fa-bluetooth-b"></i> Bluetooth Status: Connected</h3>
          <p>Device: Horiba U-52 (SN: U52-${Math.floor(Math.random() * 10000)})</p>
          <p class="success-card"><i class="fas fa-check-circle"></i> Successfully connected to device</p>
        `;
        document.getElementById('start-auto-measure').disabled = false;
      }, 2000);
    }
    
    function startAutoMeasure() {
      const params = Array.from(document.getElementById('auto-measure-parameters').selectedOptions)
        .map(opt => opt.value);
      const interval = parseInt(document.getElementById('measurement-interval').value);
      const duration = parseInt(document.getElementById('measurement-duration').value);
      const location = document.getElementById('measurement-location-auto').value;
      
      if (params.length === 0) {
        showNotification('Please select at least one parameter to measure', 'warning');
        return;
      }
      
      state.autoMeasure.running = true;
      state.autoMeasure.interval = interval;
      
      // Start timer
      const startTime = new Date();
      let elapsed = 0;
      
      // First measurement immediately
      takeAutoMeasurement(params, location);
      
      // Set up interval
      state.autoMeasure.timer = setInterval(() => {
        elapsed += interval;
        
        if (duration > 0 && elapsed >= duration) {
          stopAutoMeasure();
          return;
        }
        
        takeAutoMeasurement(params, location);
      }, interval * 1000);
      
      // Update UI
      document.getElementById('start-auto-measure').innerHTML = '<i class="fas fa-stop"></i> Stop Auto-Measure';
      document.getElementById('start-auto-measure').onclick = stopAutoMeasure;
      
      showNotification(`Auto-measure started. Recording ${params.join(', ')} every ${interval} seconds.`, 'success');
    }
    
    function takeAutoMeasurement(params, location) {
      // Simulate measurement - in a real app this would come from the device
      const timestamp = new Date();
      
      params.forEach(param => {
        let value;
        let notes = 'Auto-measured';
        
        // Generate realistic values
        switch(param) {
          case 'pH':
            value = (6.5 + Math.random() * 2.5).toFixed(2);
            break;
          case 'DO':
            value = (5 + Math.random() * 5).toFixed(2);
            break;
          case 'conductivity':
            value = Math.floor(500 + Math.random() * 1500);
            break;
          case 'temperature':
            value = (15 + Math.random() * 15).toFixed(1);
            break;
        }
        
        state.measurements.push({
          id: timestamp.getTime() + params.indexOf(param),
          timestamp,
          parameter: param,
          value: parseFloat(value),
          location,
          notes,
          unit: parameterMetadata[param].unit
        });
      });
      
      // Save and update UI
      localStorage.setItem('horibaMeasurements', JSON.stringify(state.measurements));
      updateMeasurementChart();
      updateDashboardChart();
      updateMeasurementBadge();
      
      if (document.getElementById('data').classList.contains('active')) {
        filterMeasurements();
      }
    }
    
    function stopAutoMeasure() {
      clearInterval(state.autoMeasure.timer);
      state.autoMeasure.running = false;
      
      // Update UI
      document.getElementById('start-auto-measure').innerHTML = '<i class="fas fa-play"></i> Start Auto-Measure';
      document.getElementById('start-auto-measure').onclick = startAutoMeasure;
      
      showNotification('Auto-measure stopped', 'info');
    }
    
    // UI Helper functions
    function showNotification(message, type) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `card ${type}-card`;
      notification.style.position = 'fixed';
      notification.style.bottom = '20px';
      notification.style.right = '20px';
      notification.style.zIndex = '1000';
      notification.style.maxWidth = '300px';
      notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
      notification.style.animation = 'fadeIn 0.3s ease';
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center;">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                          type === 'warning' ? 'fa-exclamation-triangle' : 
                          type === 'danger' ? 'fa-times-circle' : 'fa-info-circle'}" 
             style="font-size: 1.5rem; margin-right: 10px;"></i>
          <div>${message}</div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 5000);
    }
    
    function updateMeasurementBadge() {
      const badge = document.getElementById('measurement-badge');
      if (state.measurements.length > 0) {
        badge.textContent = state.measurements.length;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    function showContactModal() {
      document.getElementById('contact-modal').classList.add('active');
    }
    
    function sendSupportRequest() {
      const name = document.getElementById('contact-name').value;
      const email = document.getElementById('contact-email').value;
      const subject = document.getElementById('contact-subject').value;
      const message = document.getElementById('contact-message').value;
      
      if (!name || !email || !message) {
        showNotification('Please fill in all required fields', 'warning');
        return;
      }
      
      // In a real app, this would send to a server
      console.log('Support request:', { name, email, subject, message });
      
      hideModal('contact-modal');
      showNotification('Your support request has been sent. We will respond soon.', 'success');
      
      // Clear form
      document.getElementById('contact-name').value = '';
      document.getElementById('contact-email').value = '';
      document.getElementById('contact-message').value = '';
    }
    
    function showCalibrationHelp() {
      openTab('videos');
      setTimeout(() => {
        document.querySelector('.video-container iframe').scrollIntoView({
          behavior: 'smooth'
        });
      }, 300);
    }
    
    // Tour functions
    function startTour() {
      state.tour.currentStep = 0;
      showTourStep();
    }
    
    function showTourStep() {
      const step = state.tour.steps[state.tour.currentStep];
      if (!step) {
        endTour();
        return;
      }
      
      const target = document.querySelector(step.target);
      if (!target) {
        nextTourStep();
        return;
      }
      
      // Position highlight
      const rect = target.getBoundingClientRect();
      const highlight = document.getElementById('tour-highlight');
      highlight.style.width = `${rect.width}px`;
      highlight.style.height = `${rect.height}px`;
      highlight.style.top = `${rect.top + window.scrollY}px`;
      highlight.style.left = `${rect.left + window.scrollX}px`;
      
      // Position tooltip
      const tooltip = document.getElementById('tour-tooltip');
      tooltip.innerHTML = `
        <div class="tour-tooltip-title">${step.title}</div>
        <div class="tour-tooltip-content">${step.content}</div>
      `;
      
      // Position based on preference
      switch(step.position) {
        case 'top':
          tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 20}px`;
          tooltip.style.left = `${rect.left + window.scrollX}px`;
          break;
        case 'bottom':
          tooltip.style.top = `${rect.top + window.scrollY + rect.height + 20}px`;
          tooltip.style.left = `${rect.left + window.scrollX}px`;
          break;
        case 'left':
          tooltip.style.top = `${rect.top + window.scrollY}px`;
          tooltip.style.left = `${rect.left + window.scrollX - tooltip.offsetWidth - 20}px`;
          break;
        case 'right':
          tooltip.style.top = `${rect.top + window.scrollY}px`;
          tooltip.style.left = `${rect.left + window.scrollX + rect.width + 20}px`;
          break;
      }
      
      // Update progress
      document.getElementById('tour-progress').textContent = 
        `${state.tour.currentStep + 1} of ${state.tour.steps.length}`;
      
      // Show elements
      highlight.style.display = 'block';
      tooltip.classList.add('active');
    }
    
    function nextTourStep() {
      state.tour.currentStep++;
      showTourStep();
    }
    
    function prevTourStep() {
      state.tour.currentStep--;
      showTourStep();
    }
    
    function endTour() {
      document.getElementById('tour-highlight').style.display = 'none';
      document.getElementById('tour-tooltip').classList.remove('active');
      
      // Mark tour as completed
      state.settings.lastTour = new Date().getTime();
      saveSettings();
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
