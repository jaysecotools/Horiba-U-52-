<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horiba U-52 Field App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #0066cc;
      --secondary: #e6f2ff;
      --danger: #dc3545;
      --success: #28a745;
      --warning: #ffc107;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1, h2, h3 {
      color: var(--primary);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #555;
    }
    
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    
    .tab-content {
      display: none;
      padding: 20px 0;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    select, input, textarea, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #004d99;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .timer-display {
      font-size: 1.5rem;
      text-align: center;
      margin: 20px 0;
    }
    
    .progress-container {
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 10px;
      background-color: var(--primary);
      width: 0%;
      transition: width 0.3s;
    }
    
    .reading-card {
      background: var(--secondary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      margin: 20px 0;
      border-radius: 8px;
    }
    
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .instruction-card {
      background: #f8f9fa;
      border-left: 4px solid var(--primary);
      padding: 15px;
      margin: 15px 0;
    }
    
    .warning-card {
      background: #fff3cd;
      border-left: 4px solid var(--warning);
      padding: 15px;
      margin: 15px 0;
    }
    
    .step-number {
      display: inline-block;
      background: var(--primary);
      color: white;
      width: 25px;
      height: 25px;
      text-align: center;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Horiba U-52 Water Quality Meter</h1>
    <p>Complete field application for calibration, measurement, and data logging</p>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('instructions')">Instructions</button>
      <button class="tab-btn" onclick="openTab('calibration')">Calibration</button>
      <button class="tab-btn" onclick="openTab('measurement')">Measurement</button>
      <button class="tab-btn" onclick="openTab('data')">Data Log</button>
      <button class="tab-btn" onclick="openTab('videos')">Video Guides</button>
    </div>
    
    <!-- Instructions Tab -->
    <div id="instructions" class="tab-content active">
      <h2>Getting Started</h2>
      
      <div class="instruction-card">
        <h3><span class="step-number">1</span> Initial Setup</h3>
        <ol>
          <li>Install batteries or connect power adapter</li>
          <li>Attach the appropriate probes (pH, DO, conductivity)</li>
          <li>Ensure all O-rings are properly seated</li>
          <li>Power on the device</li>
        </ol>
      </div>
      
      <div class="instruction-card">
        <h3><span class="step-number">2</span> Calibration</h3>
        <p>Always calibrate:</p>
        <ul>
          <li>Before first use each day</li>
          <li>After changing probes</li>
          <li>When measurements seem inaccurate</li>
        </ul>
        <p>Use fresh calibration solutions and proper buffers</p>
      </div>
      
      <div class="warning-card">
        <h3>⚠️ Important Safety Notes</h3>
        <ul>
          <li>Never touch probe membranes with fingers</li>
          <li>Always rinse probes with DI water between measurements</li>
          <li>Store probes properly when not in use</li>
          <li>Handle calibration chemicals with care</li>
        </ul>
      </div>
      
      <button onclick="openTab('calibration')">Start Calibration Now</button>
    </div>
    
    <!-- Calibration Tab -->
    <div id="calibration" class="tab-content">
      <h2>Probe Calibration</h2>
      
      <div class="form-group">
        <label for="calibration-parameter">Select Parameter</label>
        <select id="calibration-parameter" onchange="updateCalibrationSteps()">
          <option value="">-- Select Parameter --</option>
          <option value="pH">pH</option>
          <option value="DO">Dissolved Oxygen</option>
          <option value="conductivity">Conductivity</option>
          <option value="temperature">Temperature</option>
        </select>
      </div>
      
      <div id="calibration-steps">
        <p>Please select a parameter to begin calibration</p>
      </div>
      
      <div class="video-container" id="calibration-video" style="display:none;">
        <!-- Video will be inserted dynamically -->
      </div>
      
      <div class="timer-display" id="timer-display" style="display: none;">
        Time Remaining: <span id="time-remaining">0</span>s
      </div>
      
      <div class="progress-container" id="progress-container" style="display: none;">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <button id="next-step-btn" onclick="nextCalibrationStep()" disabled>Start Calibration</button>
    </div>
    
    <!-- Measurement Tab -->
    <div id="measurement" class="tab-content">
      <h2>Take Measurements</h2>
      
      <div class="instruction-card">
        <h3>Proper Measurement Technique</h3>
        <ol>
          <li>Rinse probe with DI water</li>
          <li>Gently shake off excess water</li>
          <li>Immerse probe in sample</li>
          <li>Stir gently (for pH/DO measurements)</li>
          <li>Wait for reading to stabilize</li>
          <li>Record measurement</li>
        </ol>
      </div>
      
      <div class="form-group">
        <label for="measurement-parameter">Parameter</label>
        <select id="measurement-parameter">
          <option value="pH">pH</option>
          <option value="DO">Dissolved Oxygen</option>
          <option value="conductivity">Conductivity</option>
          <option value="temperature">Temperature</option>
          <option value="all">All Parameters</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="measurement-value">Value</label>
        <input type="number" id="measurement-value" step="0.01" placeholder="Enter reading">
      </div>
      
      <div class="form-group">
        <label for="measurement-notes">Notes (Location, Conditions, etc.)</label>
        <textarea id="measurement-notes" rows="3" placeholder="Sample details..."></textarea>
      </div>
      
      <button onclick="logMeasurement()">Record Measurement</button>
      
      <div class="chart-container">
        <canvas id="measurement-chart"></canvas>
      </div>
    </div>
    
    <!-- Data Log Tab -->
    <div id="data" class="tab-content">
      <h2>Measurement Log</h2>
      
      <div class="form-group">
        <label for="data-filter">Filter by Parameter</label>
        <select id="data-filter" onchange="filterMeasurements()">
          <option value="all">All Parameters</option>
          <option value="pH">pH</option>
          <option value="DO">Dissolved Oxygen</option>
          <option value="conductivity">Conductivity</option>
          <option value="temperature">Temperature</option>
        </select>
      </div>
      
      <div id="measurement-log">
        <p>No measurements recorded yet</p>
      </div>
      
      <button onclick="exportData()">Export Data (CSV)</button>
      <button onclick="printMeasurements()" style="background-color: var(--warning); color: black;">Print Report</button>
    </div>
    
    <!-- Video Guides Tab -->
    <div id="videos" class="tab-content">
      <h2>Video Tutorials</h2>
      
      <div class="video-container">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/9HV7SpkgonM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
      <p><strong>Horiba U-52 Overview</strong> - Basic operation and maintenance</p>
      
      <div class="video-container">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/5w6s9K97G9g" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
      <p><strong>Calibration Guide</strong> - Step-by-step probe calibration</p>
      
      <div class="instruction-card">
        <h3>Need More Help?</h3>
        <p>Consult the <a href="https://www.horiba.com" target="_blank">Horiba Official Website</a> for:</p>
        <ul>
          <li>Technical specifications</li>
          <li>Manual downloads</li>
          <li>Support contacts</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let measurements = JSON.parse(localStorage.getItem('horibaMeasurements')) || [];
    let currentCalibration = {
      parameter: null,
      step: 0,
      timer: null,
      maxTime: 0
    };
    
    // Calibration workflows with video references
    const calibrationWorkflows = {
      pH: {
        steps: [
          { instruction: "Rinse probe with deionized water", duration: 30 },
          { instruction: "Immerse probe in pH 7 buffer solution", duration: 120 },
          { instruction: "Wait for reading to stabilize", duration: 60 },
          { instruction: "Confirm calibration (enter value 7.00)", duration: 0 }
        ],
        videoId: "5w6s9K97G9g",
        videoStart: 120
      },
      DO: {
        steps: [
          { instruction: "Prepare zero oxygen solution (sodium sulfite)", duration: 60 },
          { instruction: "Immerse probe and wait for stabilization", duration: 180 },
          { instruction: "Confirm zero reading", duration: 0 },
          { instruction: "Rinse probe and expose to air", duration: 120 },
          { instruction: "Confirm air saturation (~8.2 mg/L at 20°C)", duration: 0 }
        ],
        videoId: "5w6s9K97G9g",
        videoStart: 240
      },
      conductivity: {
        steps: [
          { instruction: "Rinse probe with DI water", duration: 30 },
          { instruction: "Immerse in standard solution (e.g., 1413 µS/cm)", duration: 120 },
          { instruction: "Wait for reading to stabilize", duration: 60 },
          { instruction: "Confirm calibration value", duration: 0 }
        ],
        videoId: "9HV7SpkgonM",
        videoStart: 180
      },
      temperature: {
        steps: [
          { instruction: "Prepare ice bath (0°C) and boiling water (100°C)", duration: 60 },
          { instruction: "Immerse probe in ice bath", duration: 120 },
          { instruction: "Confirm 0°C reading", duration: 0 },
          { instruction: "Transfer to boiling water (caution!)", duration: 120 },
          { instruction: "Confirm 100°C reading", duration: 0 }
        ],
        videoId: "9HV7SpkgonM",
        videoStart: 300
      }
    };
    
    // Tab navigation
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[onclick="openTab('${tabId}')"]`).classList.add('active');
      
      // Special tab handling
      if (tabId === 'data') {
        renderMeasurementLog();
      } else if (tabId === 'measurement') {
        updateMeasurementChart();
      }
    }
    
    // Calibration functions
    function updateCalibrationSteps() {
      const parameter = document.getElementById('calibration-parameter').value;
      if (!parameter) return;
      
      currentCalibration.parameter = parameter;
      currentCalibration.step = 0;
      
      const workflow = calibrationWorkflows[parameter];
      const stepsContainer = document.getElementById('calibration-steps');
      
      stepsContainer.innerHTML = `
        <h3>${parameter} Calibration</h3>
        <p>${workflow.steps[0].instruction}</p>
        <p class="warning-card"><strong>Tip:</strong> Watch the <a href="#videos" onclick="openTab('videos')">video guide</a> for visual instructions</p>
      `;
      
      // Show relevant video
      const videoContainer = document.getElementById('calibration-video');
      videoContainer.style.display = 'block';
      videoContainer.innerHTML = `
        <iframe width="560" height="315" src="https://www.youtube.com/embed/${workflow.videoId}?start=${workflow.videoStart}" 
        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      `;
      
      document.getElementById('next-step-btn').disabled = false;
      document.getElementById('next-step-btn').textContent = 'Start Step';
      document.getElementById('timer-display').style.display = 'none';
      document.getElementById('progress-container').style.display = 'none';
    }
    
    function nextCalibrationStep() {
      const parameter = currentCalibration.parameter;
      const step = currentCalibration.step;
      const workflow = calibrationWorkflows[parameter];
      
      // If we're at the last step, complete calibration
      if (step >= workflow.steps.length - 1) {
        completeCalibration();
        return;
      }
      
      // Start timer for current step
      const duration = workflow.steps[step].duration;
      if (duration > 0) {
        startTimer(duration);
      }
      
      // Update UI for next step
      currentCalibration.step++;
      document.getElementById('calibration-steps').innerHTML = `
        <h3>Step ${currentCalibration.step + 1} of ${workflow.steps.length}</h3>
        <p>${workflow.steps[currentCalibration.step].instruction}</p>
      `;
      
      if (currentCalibration.step >= workflow.steps.length - 1) {
        document.getElementById('next-step-btn').textContent = 'Complete Calibration';
      } else {
        document.getElementById('next-step-btn').textContent = 'Next Step';
      }
    }
    
    function startTimer(seconds) {
      // Clear any existing timer
      if (currentCalibration.timer) {
        clearInterval(currentCalibration.timer);
      }
      
      currentCalibration.maxTime = seconds;
      let remaining = seconds;
      
      // Show timer UI
      document.getElementById('timer-display').style.display = 'block';
      document.getElementById('progress-container').style.display = 'block';
      
      // Update timer every second
      currentCalibration.timer = setInterval(() => {
        remaining--;
        document.getElementById('time-remaining').textContent = remaining;
        const percent = ((currentCalibration.maxTime - remaining) / currentCalibration.maxTime) * 100;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        
        if (remaining <= 0) {
          clearInterval(currentCalibration.timer);
          document.getElementById('next-step-btn').disabled = false;
        }
      }, 1000);
      
      document.getElementById('next-step-btn').disabled = true;
    }
    
    function completeCalibration() {
      const parameter = currentCalibration.parameter;
      const now = new Date();
      
      // Update status display
      document.getElementById(`${parameter.toLowerCase()}-calibration-date`).textContent = now.toLocaleString();
      document.getElementById(`${parameter.toLowerCase()}-status`).textContent = 'Calibrated';
      document.getElementById(`${parameter.toLowerCase()}-status`).style.color = 'var(--success)';
      
      // Reset calibration UI
      document.getElementById('calibration-steps').innerHTML = `
        <h3>${parameter} Calibration Complete!</h3>
        <p>Calibration performed at ${now.toLocaleTimeString()}</p>
        <p>Proceed to <a href="#measurement" onclick="openTab('measurement')">measurement</a> or <a href="#videos" onclick="openTab('videos')">watch more videos</a></p>
      `;
      document.getElementById('next-step-btn').disabled = true;
      document.getElementById('timer-display').style.display = 'none';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('calibration-video').style.display = 'none';
      
      alert(`${parameter} calibration completed successfully!`);
    }
    
    // Measurement functions
    function logMeasurement() {
      const parameter = document.getElementById('measurement-parameter').value;
      const value = parseFloat(document.getElementById('measurement-value').value);
      const notes = document.getElementById('measurement-notes').value;
      
      if (isNaN(value)) {
        alert('Please enter a valid measurement value');
        return;
      }
      
      const measurement = {
        id: Date.now(),
        timestamp: new Date(),
        parameter,
        value,
        notes,
        unit: getUnitForParameter(parameter)
      };
      
      measurements.push(measurement);
      localStorage.setItem('horibaMeasurements', JSON.stringify(measurements));
      
      // Clear form
      document.getElementById('measurement-value').value = '';
      document.getElementById('measurement-notes').value = '';
      
      // Update UI
      updateMeasurementChart();
      renderMeasurementLog();
      
      // Auto-switch to data tab if not already there
      if (!document.getElementById('data').classList.contains('active')) {
        openTab('data');
      }
    }
    
    function getUnitForParameter(parameter) {
      const units = {
        pH: 'pH',
        DO: 'mg/L',
        conductivity: 'µS/cm',
        temperature: '°C'
      };
      return units[parameter] || '';
    }
    
    function updateMeasurementChart() {
      const ctx = document.getElementById('measurement-chart').getContext('2d');
      
      // Filter measurements for the selected parameter
      const selectedParam = document.getElementById('measurement-parameter').value;
      const filtered = selectedParam === 'all' 
        ? measurements 
        : measurements.filter(m => m.parameter === selectedParam);
      
      // Group by parameter for charting
      const datasets = [];
      const params = [...new Set(filtered.map(m => m.parameter))];
      
      params.forEach(param => {
        const paramMeasurements = filtered.filter(m => m.parameter === param);
        datasets.push({
          label: param,
          data: paramMeasurements.map(m => m.value),
          borderColor: getColorForParameter(param),
          backgroundColor: 'rgba(0,0,0,0.1)',
          tension: 0.1
        });
      });
      
      // Destroy existing chart if it exists
      if (window.measurementChart) {
        window.measurementChart.destroy();
      }
      
      // Create new chart
      window.measurementChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filtered.map(m => m.timestamp.toLocaleTimeString()),
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }
    
    function getColorForParameter(parameter) {
      const colors = {
        pH: '#4bc0c0',
        DO: '#ff6384',
        conductivity: '#36a2eb',
        temperature: '#ff9f40'
      };
      return colors[parameter] || '#9966ff';
    }
    
    // Data log functions
    function renderMeasurementLog() {
      const container = document.getElementById('measurement-log');
      const filter = document.getElementById('data-filter').value;
      
      const filtered = filter === 'all' 
        ? measurements 
        : measurements.filter(m => m.parameter === filter);
      
      if (filtered.length === 0) {
        container.innerHTML = '<p>No measurements recorded yet</p>';
        return;
      }
      
      container.innerHTML = filtered.map(m => `
        <div class="reading-card">
          <h3>${m.parameter}: ${m.value} ${m.unit}</h3>
          <p>${m.timestamp.toLocaleString()}</p>
          ${m.notes ? `<p>Notes: ${m.notes}</p>` : ''}
          <button onclick="deleteMeasurement(${m.id})" style="background-color: var(--danger); margin-top: 5px;">Delete</button>
        </div>
      `).join('');
    }
    
    function filterMeasurements() {
      renderMeasurementLog();
    }
    
    function deleteMeasurement(id) {
      if (confirm('Are you sure you want to delete this measurement?')) {
        measurements = measurements.filter(m => m.id !== id);
        localStorage.setItem('horibaMeasurements', JSON.stringify(measurements));
        renderMeasurementLog();
        updateMeasurementChart();
      }
    }
    
    function exportData() {
      if (measurements.length === 0) {
        alert('No measurements to export');
        return;
      }
      
      const filter = document.getElementById('data-filter').value;
      const filtered = filter === 'all' 
        ? measurements 
        : measurements.filter(m => m.parameter === filter);
      
      // Convert to CSV
      const headers = ['Timestamp', 'Parameter', 'Value', 'Unit', 'Notes'];
      const rows = filtered.map(m => [
        m.timestamp.toISOString(),
        m.parameter,
        m.value,
        m.unit,
        m.notes || ''
      ]);
      
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `horiba_measurements_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    function printMeasurements() {
      const printWindow = window.open('', '_blank');
      const filter = document.getElementById('data-filter').value;
      const filtered = filter === 'all' 
        ? measurements 
        : measurements.filter(m => m.parameter === filter);
      
      printWindow.document.write(`
        <html>
          <head>
            <title>Horiba U-52 Measurement Report</title>
            <style>
              body { font-family: Arial; margin: 20px; }
              h1 { color: #0066cc; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
            </style>
          </head>
          <body>
            <h1>Horiba U-52 Measurement Report</h1>
            <p>Generated: ${new Date().toLocaleString()}</p>
            <p>Filter: ${filter === 'all' ? 'All Parameters' : filter}</p>
            
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Parameter</th>
                  <th>Value</th>
                  <th>Unit</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                ${filtered.map(m => `
                  <tr>
                    <td>${m.timestamp.toLocaleString()}</td>
                    <td>${m.parameter}</td>
                    <td>${m.value}</td>
                    <td>${m.unit}</td>
                    <td>${m.notes || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderMeasurementLog();
      
      // Set up video tab to show both videos
      document.getElementById('videos').innerHTML += `
        <div class="video-container">
          <iframe width="560" height="315" src="https://www.youtube.com/embed/9HV7SpkgonM" frameborder="0" allowfullscreen></iframe>
        </div>
        <div class="video-container">
          <iframe width="560" height="315" src="https://www.youtube.com/embed/5w6s9K97G9g" frameborder="0" allowfullscreen></iframe>
        </div>
      `;
    });
  </script>
</body>
</html>
